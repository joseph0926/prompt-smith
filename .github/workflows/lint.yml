name: Skill Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  SKILL_PATH: skills/prompt-smith

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate SKILL.md exists
        run: test -f ${{ env.SKILL_PATH }}/SKILL.md

      - name: Validate frontmatter
        run: |
          head -20 ${{ env.SKILL_PATH }}/SKILL.md | grep -q "^name:"
          head -20 ${{ env.SKILL_PATH }}/SKILL.md | grep -q "^description:"

      - name: Validate i18n structure
        run: |
          if [ -d "${{ env.SKILL_PATH }}/i18n" ]; then
            for locale in ${{ env.SKILL_PATH }}/i18n/*/; do
              test -f "${locale}SKILL.md"
            done
          fi

      - name: Check required directories
        run: |
          test -d ${{ env.SKILL_PATH }}/onboarding
          test -d ${{ env.SKILL_PATH }}/playbooks
          test -d ${{ env.SKILL_PATH }}/references
          test -d ${{ env.SKILL_PATH }}/templates

      - name: Validate marketplace.json
        run: |
          if [ -f "${{ env.SKILL_PATH }}/marketplace.json" ]; then
            python3 -c "import json; json.load(open('${{ env.SKILL_PATH }}/marketplace.json'))"
          fi

      - name: Check deprecated /prompt-smith references
        run: |
          # Check for deprecated slash command "/prompt-smith" (not folder paths)
          # Pattern: backtick/prompt-smith (command in markdown) followed by space/backtick/end
          # Excludes: github.com URLs, folder paths, changelog migration mentions (→)
          FOUND=$(grep -rEh '`/prompt-smith' --include="*.md" \
            --exclude="CHANGELOG.md" \
            --exclude="*-review-report.md" \
            ${{ env.SKILL_PATH }}/ 2>/dev/null | \
            grep -v "github.com/.*prompt-smith" | \
            grep -v "→.*ps:" | wc -l || echo "0")
          if [ "$FOUND" -gt 0 ]; then
            echo "Found deprecated /prompt-smith command references:"
            grep -rE '`/prompt-smith' --include="*.md" \
              --exclude="CHANGELOG.md" \
              --exclude="*-review-report.md" \
              ${{ env.SKILL_PATH }}/ | \
              grep -v "github.com/.*prompt-smith" | \
              grep -v "→.*ps:"
            echo ""
            echo "Please use /ps:r or /ps:a instead."
            exit 1
          fi

      - name: Check SKILL.md size
        run: |
          SIZE=$(wc -c < ${{ env.SKILL_PATH }}/SKILL.md)
          if [ "$SIZE" -gt 30000 ]; then
            echo "SKILL.md exceeds 30KB limit: $SIZE bytes"
            echo "Consider moving content to references/ directory"
            exit 1
          fi
          echo "SKILL.md size: $SIZE bytes (limit: 30000)"

      - name: Check version consistency
        run: |
          PLUGIN_VER=$(python3 -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['version'])")
          SKILL_MARKETPLACE_VER=$(python3 -c "import json; print(json.load(open('${{ env.SKILL_PATH }}/marketplace.json'))['version'])")

          echo "Plugin version: $PLUGIN_VER"
          echo "Skill marketplace version: $SKILL_MARKETPLACE_VER"

          if [ "$PLUGIN_VER" != "$SKILL_MARKETPLACE_VER" ]; then
            echo "Version mismatch detected!"
            echo "  .claude-plugin/plugin.json: $PLUGIN_VER"
            echo "  ${{ env.SKILL_PATH }}/marketplace.json: $SKILL_MARKETPLACE_VER"
            exit 1
          fi
          echo "Version consistency check passed: $PLUGIN_VER"

      - name: Check forbidden tokens
        run: |
          # Use -- to prevent patterns starting with - from being interpreted as options
          FOUND=$(grep -rE -- '--threshold|--verbose' --include="*.md" ${{ env.SKILL_PATH }}/ 2>/dev/null | \
            grep -v "CHANGELOG.md" | wc -l || echo "0")
          if [ "$FOUND" -gt 0 ]; then
            echo "Forbidden tokens found (--threshold, --verbose are removed options):"
            grep -rE -- '--threshold|--verbose' --include="*.md" ${{ env.SKILL_PATH }}/ | grep -v "CHANGELOG.md"
            exit 1
          fi
          echo "No forbidden tokens found"

      - name: Check forbidden artifacts
        run: |
          echo "Checking for forbidden artifacts..."
          ERRORS=0

          # Check for .DS_Store files
          DS_STORE=$(find . -name ".DS_Store" -not -path "./.git/*" 2>/dev/null | wc -l || echo "0")
          if [ "$DS_STORE" -gt 0 ]; then
            echo "❌ Found .DS_Store files:"
            find . -name ".DS_Store" -not -path "./.git/*"
            ERRORS=$((ERRORS + 1))
          fi

          # Check for __MACOSX directories
          MACOSX=$(find . -name "__MACOSX" -type d -not -path "./.git/*" 2>/dev/null | wc -l || echo "0")
          if [ "$MACOSX" -gt 0 ]; then
            echo "❌ Found __MACOSX directories:"
            find . -name "__MACOSX" -type d -not -path "./.git/*"
            ERRORS=$((ERRORS + 1))
          fi

          # Check for .env files (should not be committed)
          ENV_FILES=$(find . -name ".env" -o -name ".env.*" 2>/dev/null | grep -v "./.git/" | wc -l || echo "0")
          if [ "$ENV_FILES" -gt 0 ]; then
            echo "❌ Found .env files:"
            find . -name ".env" -o -name ".env.*" | grep -v "./.git/"
            ERRORS=$((ERRORS + 1))
          fi

          if [ "$ERRORS" -gt 0 ]; then
            echo ""
            echo "Please remove forbidden artifacts before committing."
            exit 1
          fi
          echo "✅ No forbidden artifacts found"

      - name: Check internal markdown links
        run: |
          echo "Checking internal markdown links..."
          ERRORS=0

          # Check links in skills directory
          for file in $(find ${{ env.SKILL_PATH }} -name "*.md" 2>/dev/null); do
            # Extract markdown links [text](path)
            links=$(grep -oE '\[([^\]]+)\]\(([^)]+)\)' "$file" 2>/dev/null | \
              grep -oE '\]\([^)]+\)' | sed 's/\](//' | sed 's/)$//' || true)

            dir=$(dirname "$file")
            for link in $links; do
              # Skip external URLs, anchors, and mailto
              if [[ "$link" == http* ]] || [[ "$link" == "#"* ]] || [[ "$link" == "mailto:"* ]]; then
                continue
              fi

              # Remove anchor from link
              link_path="${link%%#*}"
              if [ -z "$link_path" ]; then
                continue
              fi

              # Resolve relative path
              if [[ "$link_path" == /* ]]; then
                target="$link_path"
              else
                target="$dir/$link_path"
              fi

              # Check if file exists
              if [ ! -f "$target" ] && [ ! -d "$target" ]; then
                echo "❌ Broken link in $file: $link"
                ERRORS=$((ERRORS + 1))
              fi
            done
          done

          if [ "$ERRORS" -gt 0 ]; then
            echo ""
            echo "Found $ERRORS broken links. Please fix them."
            exit 1
          fi
          echo "✅ All internal links are valid"

      - name: Check commands/ directory
        run: |
          echo "Checking commands/ directory..."
          ERRORS=0

          # Check required commands exist
          for cmd in help.md lint.md build.md r.md a.md; do
            if [ ! -f "commands/$cmd" ]; then
              echo "❌ Missing required command: commands/$cmd"
              ERRORS=$((ERRORS + 1))
            fi
          done

          # Check internal links in commands/
          for file in $(find commands -name "*.md" 2>/dev/null); do
            links=$(grep -oE '\[([^\]]+)\]\(([^)]+)\)' "$file" 2>/dev/null | \
              grep -oE '\]\([^)]+\)' | sed 's/\](//' | sed 's/)$//' || true)

            dir=$(dirname "$file")
            for link in $links; do
              if [[ "$link" == http* ]] || [[ "$link" == "#"* ]] || [[ "$link" == "mailto:"* ]]; then
                continue
              fi

              link_path="${link%%#*}"
              if [ -z "$link_path" ]; then
                continue
              fi

              if [[ "$link_path" == /* ]]; then
                target="$link_path"
              else
                target="$dir/$link_path"
              fi

              if [ ! -f "$target" ] && [ ! -d "$target" ]; then
                echo "❌ Broken link in $file: $link"
                ERRORS=$((ERRORS + 1))
              fi
            done
          done

          if [ "$ERRORS" -gt 0 ]; then
            echo ""
            echo "Found $ERRORS issues in commands/. Please fix them."
            exit 1
          fi
          echo "✅ commands/ directory check passed"

      - name: Check extended version consistency
        run: |
          VERSION_FILE=$(cat VERSION 2>/dev/null || echo "")
          if [ -z "$VERSION_FILE" ]; then
            echo "VERSION file not found, skipping extended check"
            exit 0
          fi

          ERRORS=0
          echo "VERSION file: $VERSION_FILE"

          # Check .claude-plugin/marketplace.json
          if [ -f ".claude-plugin/marketplace.json" ]; then
            MARKET_VER=$(python3 -c "import json; print(json.load(open('.claude-plugin/marketplace.json'))['metadata']['version'])")
            if [ "$VERSION_FILE" != "$MARKET_VER" ]; then
              echo "❌ .claude-plugin/marketplace.json version mismatch: $MARKET_VER"
              ERRORS=$((ERRORS + 1))
            fi
          fi

          # Check i18n SKILL.md files
          for skill_file in $(find ${{ env.SKILL_PATH }}/i18n -name "SKILL.md" 2>/dev/null); do
            SKILL_VER=$(grep -oE '^version:\s*"?([0-9.]+)"?' "$skill_file" | grep -oE '[0-9.]+' || echo "")
            if [ -n "$SKILL_VER" ] && [ "$VERSION_FILE" != "$SKILL_VER" ]; then
              echo "❌ $skill_file version mismatch: $SKILL_VER"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ "$ERRORS" -gt 0 ]; then
            echo ""
            echo "Run 'python3 scripts/sync-version.py' to fix version mismatches."
            exit 1
          fi
          echo "✅ Extended version consistency check passed"
