# Prompt Chaining 가이드

복잡한 작업을 여러 프롬프트로 분할하여 품질과 신뢰성을 높이는 전략입니다.

> **관련 참조**: anti-patterns.md의 "과도한 복잡성" 패턴의 해결책

---

## Chaining이 필요한 경우

```
┌─────────────────────────────────────────────────────────────┐
│  Chaining 적용 조건                                          │
├─────────────────────────────────────────────────────────────┤
│  • 3개 이상의 의존적 단계가 있는 작업                          │
│  • 단일 프롬프트 응답이 토큰 한계에 근접                        │
│  • 중간 결과 검증이 필요한 경우                                │
│  • 롤백/재시도가 필요한 복잡한 변환                            │
│  • 부분 실패 허용이 필요한 대량 작업                           │
└─────────────────────────────────────────────────────────────┘
```

### Chaining이 불필요한 경우

- 단일 단계로 완료 가능한 작업
- 중간 검증이 필요 없는 간단한 변환
- 오버헤드가 작업 복잡도보다 큰 경우

---

## Chaining 패턴

### 1. 순차 체인 (Sequential)

각 단계의 출력이 다음 단계의 입력이 됨.

```
[Input] → [Step 1: 분석] → [Step 2: 변환] → [Step 3: 검증] → [Output]
```

**적용 상황**:
- 데이터 변환 파이프라인
- 문서 마이그레이션
- 단계별 리팩토링

**예시**:
```markdown
Step 1: 파일 읽기 → 구조 분석
Step 2: 분석 결과 → 변환 계획 수립
Step 3: 계획 → 코드 수정
Step 4: 수정 결과 → 테스트 실행
```

### 2. 분기 체인 (Branching)

조건에 따라 다른 경로로 분기.

```
            ┌→ [Step 2A: 옵션 A]
[Step 1] ──┤
            └→ [Step 2B: 옵션 B]
                     ↓
               [Step 3: 선택/통합]
```

**적용 상황**:
- A/B 테스트 생성
- 다중 접근법 비교
- 조건부 처리

### 3. 병렬 체인 (Parallel)

독립적인 작업을 동시 실행 후 결과 통합.

```
         ┌→ [Task A] ─┐
[Input] ─┼→ [Task B] ─┼→ [Merge] → [Output]
         └→ [Task C] ─┘
```

**적용 상황**:
- 여러 파일 동시 분석
- 독립적인 검증 작업
- 대량 데이터 처리

**Claude 4.x에서의 구현**:
```markdown
## Tool Usage Strategy
### Step 1: 병렬 분석
동시 실행:
- Read: file_a.ts
- Read: file_b.ts
- Read: file_c.ts
→ 세 작업은 서로 독립적

### Step 2: 통합
모든 읽기 완료 후:
- 분석 결과 종합
- 통합 보고서 생성
```

---

## 상태 관리

### 상태 파일 구조

```json
{
  "chain_id": "doc-migration-001",
  "current_step": 2,
  "total_steps": 5,
  "status": "in_progress",
  "steps": [
    {
      "name": "extract",
      "status": "completed",
      "output_ref": "step1.json",
      "completed_at": "2026-01-03T10:00:00Z"
    },
    {
      "name": "transform",
      "status": "in_progress",
      "output_ref": null,
      "started_at": "2026-01-03T10:05:00Z"
    },
    {
      "name": "validate",
      "status": "pending",
      "output_ref": null
    }
  ],
  "checkpoint": "2026-01-03T10:05:00Z",
  "errors": []
}
```

### 체크포인트 규칙

| 시점 | 저장 내용 | 이유 |
|------|----------|------|
| 각 단계 완료 후 | 단계 결과 + 상태 | 재개 가능 |
| 에러 발생 시 | 에러 정보 + 마지막 성공 상태 | 디버깅 |
| N개 항목 처리 후 | 진행률 + 중간 결과 | 장기 작업 추적 |

---

## 에러 처리 전략

| 전략 | 설명 | 적용 상황 |
|------|------|----------|
| **Retry** | 동일 단계 재시도 | 일시적 오류 (네트워크, 타임아웃) |
| **Fallback** | 대체 접근법 시도 | 특정 입력에서 실패 |
| **Skip** | 해당 항목 건너뛰기 | 일부 실패 허용 시 (대량 처리) |
| **Rollback** | 이전 체크포인트로 복귀 | 심각한 오류 |
| **Abort** | 전체 체인 중단 | 치명적 오류 |

### 에러 처리 예시

```markdown
## Error Handling
- Read 실패 → Skip (해당 파일 스킵, 에러 로그 기록)
- Transform 실패 → Retry (최대 2회)
- Validate 실패 → Rollback (수정 전 상태로)
- 연속 3회 실패 → Abort (사용자에게 알림)
```

---

## 예시: 문서 마이그레이션 체인

### 전체 흐름

```
┌───────────────────────────────────────────────────────────────┐
│ Step 1: [파일 목록 수집]                                       │
│   Input: 디렉토리 경로                                         │
│   Output: 변환 대상 파일 목록 (files.json)                      │
├───────────────────────────────────────────────────────────────┤
│ Step 2: [각 파일 분석] ← 병렬 가능                             │
│   Input: 파일 경로                                             │
│   Output: AST 또는 구조 분석 결과                              │
├───────────────────────────────────────────────────────────────┤
│ Step 3: [변환 규칙 적용] ← 순차                                │
│   Input: 분석 결과 + 변환 규칙                                 │
│   Output: 변환된 코드                                          │
├───────────────────────────────────────────────────────────────┤
│ Step 4: [검증] ← 병렬 가능                                     │
│   Input: 변환된 파일                                           │
│   Output: 테스트 통과 여부                                     │
├───────────────────────────────────────────────────────────────┤
│ Step 5: [커밋] ← 순차                                          │
│   Input: 검증 완료 파일                                        │
│   Output: Git 커밋                                             │
└───────────────────────────────────────────────────────────────┘
```

### 상세 프롬프트 구조

```markdown
## Chain: Jest → Vitest Migration

### Step 1 Prompt
목표: 마이그레이션 대상 파일 목록 수집

Glob 패턴: **/*.test.ts, **/*.spec.ts
제외: node_modules/, dist/
출력: JSON 배열 (파일 경로)

### Step 2 Prompt (각 파일에 대해)
목표: 파일 구조 분석

분석 대상:
- import 문
- describe/it 블록 구조
- mock 사용 패턴
- 타이머/비동기 패턴

출력: 구조화된 분석 결과 (JSON)

### Step 3 Prompt
목표: Jest → Vitest 변환

입력: Step 2의 분석 결과
변환 규칙:
- jest.fn() → vi.fn()
- jest.mock() → vi.mock()
- beforeEach → beforeEach (유지)
- jest.useFakeTimers() → vi.useFakeTimers()

출력: 변환된 코드

### Step 4 Prompt
목표: 변환 결과 검증

검증 항목:
- TypeScript 컴파일 성공
- Vitest 실행 성공
- 테스트 통과율 유지

### Step 5
Bash: git add . && git commit -m "chore: migrate tests from Jest to Vitest"
```

---

## 성능 최적화

### 병렬 vs 순차 판단 기준

| 조건 | 전략 | 예시 |
|------|------|------|
| 데이터 의존성 없음 | 병렬 | 여러 파일 동시 읽기 |
| 결과 의존성 있음 | 순차 | 분석 → 변환 → 검증 |
| 리소스 경합 가능 | 순차 | 동일 파일 수정 |
| 순서 무관 | 병렬 | 독립적인 검증 |

### 토큰 효율성

- 각 단계의 프롬프트를 **최소화**
- 이전 단계 결과는 **필요한 부분만** 전달
- 상태 파일로 컨텍스트 분리

```markdown
# ❌ 비효율적
전체 이전 대화 컨텍스트 포함

# ✅ 효율적
이전 단계 결과를 별도 파일에 저장
현재 단계에서 필요한 부분만 읽기
```

---

## 체크리스트

```
┌─ Prompt Chaining 설계 체크리스트 ────────────────────────────┐
│                                                             │
│  설계 단계                                                   │
│  □ 전체 단계 수 확정 (3개 이상인가?)                          │
│  □ 각 단계의 입력/출력 정의                                  │
│  □ 병렬/순차 실행 전략 결정                                  │
│  □ 상태 파일 구조 설계                                       │
│                                                             │
│  구현 단계                                                   │
│  □ 각 단계별 프롬프트 작성                                   │
│  □ 에러 처리 전략 정의                                       │
│  □ 체크포인트 시점 설정                                      │
│  □ 재개 로직 구현                                           │
│                                                             │
│  검증 단계                                                   │
│  □ 정상 케이스 테스트                                        │
│  □ 에러 케이스 테스트                                        │
│  □ 중단/재개 테스트                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 관련 참조

- [claude-4x-best-practices.md](../references/claude-4x-best-practices.md) - PARALLELIZED 패턴
- [state-tracking-guide.md](../references/state-tracking-guide.md) - 상태 관리 상세
- [tool-usage-guide.md](../references/tool-usage-guide.md) - 도구 사용 전략
- [anti-patterns.md](../references/anti-patterns.md) - 과도한 복잡성 방지
