# Long Context Optimization 가이드

대용량 문서 처리 및 긴 컨텍스트 최적화를 위한 상세 가이드입니다.

---

## 개요

### 적용 조건
- 입력 문서 > 10K 토큰
- 여러 문서 동시 참조
- RAG 검색 결과 포함
- 긴 대화 히스토리 유지

### 주요 과제
- 컨텍스트 윈도우 한계 (200K 토큰)
- 긴 문서에서 관련 정보 추출
- 할루시네이션 방지
- 응답 지연 및 비용 최적화

---

## 문서 배치 전략

### 1. 위치 중요도

```
┌─────────────────────────────────────────────────────────────┐
│              프롬프트 구조 (긴 컨텍스트)                       │
├─────────────────────────────────────────────────────────────┤
│  [상단] 시스템 지시 + 핵심 질문                               │
│         → Claude가 가장 잘 참조하는 위치                      │
│  ─────────────────────────────────────────────────────────  │
│  [중단] 가장 관련성 높은 문서                                 │
│         → 질문 근처에 배치                                   │
│  ─────────────────────────────────────────────────────────  │
│  [하단] 추가 참고 문서                                       │
│         → 필요시 참조                                        │
└─────────────────────────────────────────────────────────────┘
```

### 2. 관련성 기반 정렬

```markdown
## 권장 구조

<question>
{{user_question}}
</question>

<primary_documents>
<!-- 가장 관련성 높은 문서 (Top-3) -->
<doc id="1" relevance="0.95">...</doc>
<doc id="2" relevance="0.88">...</doc>
<doc id="3" relevance="0.82">...</doc>
</primary_documents>

<secondary_documents>
<!-- 추가 참고 문서 -->
<doc id="4" relevance="0.65">...</doc>
</secondary_documents>

<instructions>
1. primary_documents를 우선적으로 참조하세요
2. 답변에 사용한 문서 ID를 인용하세요 [Doc X]
3. 문서에 없는 정보는 "확인할 수 없음"으로 표시하세요
</instructions>
```

---

## 문서 청킹 (Chunking) 전략

### 1. 청킹 방법 비교

| 방법 | 설명 | 장점 | 단점 | 권장 사용 |
|------|------|------|------|----------|
| **고정 크기** | 일정 토큰/문자 단위 분할 | 구현 간단 | 의미 단위 파괴 | 빠른 처리 필요 시 |
| **의미 단위** | 문단, 섹션 기준 분할 | 문맥 유지 | 불균일 크기 | 문서 요약, Q&A |
| **오버랩** | 청크 간 10-20% 중복 | 정보 손실 방지 | 중복 비용 | 검색 정확도 중요 시 |
| **재귀적** | 큰 단위 → 작은 단위 분할 | 계층 구조 유지 | 복잡한 구현 | 구조화된 문서 |

### 2. 권장 청크 크기

| 문서 유형 | 권장 크기 | 오버랩 |
|----------|----------|--------|
| 일반 텍스트 | 1,000-2,000 토큰 | 10% |
| 기술 문서 | 500-1,000 토큰 | 15% |
| 코드 | 함수/클래스 단위 | 20% |
| 법률 문서 | 조항/섹션 단위 | 10% |

### 3. 청킹 예시

```markdown
## 원본 문서 (5,000 토큰)

[서론] 500 토큰
[본론 1] 1,500 토큰
[본론 2] 2,000 토큰
[결론] 1,000 토큰

## 의미 단위 청킹

Chunk 1: [서론] + [본론 1 앞부분] → 1,000 토큰
Chunk 2: [본론 1 뒷부분] + [본론 2 앞부분] → 1,500 토큰 (오버랩 200)
Chunk 3: [본론 2 뒷부분] + [결론] → 1,500 토큰 (오버랩 200)
```

---

## 관련성 필터링

### 1. Top-K 선택

```markdown
## 프로세스

1. 질문 임베딩 생성
2. 문서 청크 임베딩과 유사도 계산
3. Top-K 청크 선택 (K=5-10)
4. 중복 제거 (semantic deduplication)
5. 관련성 순 정렬

## 예시

질문: "반품 정책이 어떻게 되나요?"

검색 결과:
| 순위 | 청크 ID | 유사도 | 내용 요약 |
|------|---------|--------|----------|
| 1 | chunk_42 | 0.92 | 반품 절차 및 기간 |
| 2 | chunk_15 | 0.88 | 환불 정책 |
| 3 | chunk_78 | 0.85 | 교환 조건 |
| 4 | chunk_23 | 0.71 | 배송 정책 (제외) |

→ Top-3 선택하여 프롬프트에 포함
```

### 2. 최소 유사도 임계값

| 작업 유형 | 임계값 | 이유 |
|----------|--------|------|
| 정확한 답변 필요 | 0.8 이상 | 관련 없는 문서 제외 |
| 탐색적 질문 | 0.6 이상 | 넓은 범위 포함 |
| 창의적 작업 | 0.5 이상 | 다양한 영감 |

---

## 계층적 요약 (Map-Reduce)

### 1. 패턴

```
┌─────────────────────────────────────────────────────────────┐
│              Map-Reduce 패턴                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [Map Phase]                                                │
│  ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐                 │
│  │Doc 1 │   │Doc 2 │   │Doc 3 │   │Doc 4 │                 │
│  └──┬───┘   └──┬───┘   └──┬───┘   └──┬───┘                 │
│     ↓          ↓          ↓          ↓                      │
│  ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐                 │
│  │요약 1│   │요약 2│   │요약 3│   │요약 4│                 │
│  └──┬───┘   └──┬───┘   └──┬───┘   └──┬───┘                 │
│     └──────────┴──────────┴──────────┘                      │
│                      ↓                                      │
│  [Reduce Phase]                                             │
│              ┌──────────────┐                               │
│              │  통합 요약    │                               │
│              └──────┬───────┘                               │
│                     ↓                                       │
│              ┌──────────────┐                               │
│              │  최종 답변    │                               │
│              └──────────────┘                               │
└─────────────────────────────────────────────────────────────┘
```

### 2. Map 프롬프트

```markdown
## 지시
아래 문서를 요약하세요. 핵심 정보만 추출하여 500자 이내로 작성하세요.

<document>
{{document_chunk}}
</document>

## 출력 형식
<summary>
- 핵심 주제: [한 줄 요약]
- 주요 내용:
  1. [핵심 포인트 1]
  2. [핵심 포인트 2]
  3. [핵심 포인트 3]
- 관련 키워드: [키워드 목록]
</summary>
```

### 3. Reduce 프롬프트

```markdown
## 지시
아래 개별 요약들을 종합하여 최종 답변을 작성하세요.

<question>
{{user_question}}
</question>

<summaries>
{{map_summaries}}
</summaries>

## 요구사항
1. 모든 요약의 관련 정보를 통합
2. 중복 제거 및 일관성 유지
3. 원본 요약 번호 인용 [Summary X]
4. 정보 부족 시 명시
```

---

## 인용 기반 응답 패턴

### 1. 2단계 응답 (할루시네이션 방지)

```markdown
## Step 1: 관련 인용 추출

아래 문서에서 질문과 관련된 정확한 인용을 추출하세요.

<question>
{{question}}
</question>

<documents>
{{documents}}
</documents>

<relevant_quotes>
[Doc 1, Section 2]: "정확한 인용 문구"
[Doc 3, Section 5]: "정확한 인용 문구"
</relevant_quotes>

## Step 2: 인용 기반 답변

위 <relevant_quotes>만 사용하여 답변하세요.
인용에 없는 정보는 추측하지 마세요.

<answer>
[인용 기반 답변]

출처:
- [Doc 1, Section 2]
- [Doc 3, Section 5]
</answer>
```

### 2. 인용 검증 체크리스트

```markdown
## 답변 검증

- [ ] 모든 주장에 인용이 있는가?
- [ ] 인용이 원문과 정확히 일치하는가?
- [ ] 인용 범위를 벗어난 추론이 있는가?
- [ ] "확인할 수 없음"을 적절히 사용했는가?
```

---

## 프롬프트 템플릿

### 긴 컨텍스트 Q&A 템플릿

```markdown
## 역할
당신은 문서 분석 전문가입니다. 제공된 문서만을 기반으로 정확하게 답변합니다.

## 질문
<question>
{{user_question}}
</question>

## 문서
<documents>
<doc id="1" source="{{source_1}}">
{{document_1}}
</doc>
<doc id="2" source="{{source_2}}">
{{document_2}}
</doc>
</documents>

## 지시
1. 문서에서 관련 정보를 먼저 추출하세요
2. 추출한 정보만으로 답변하세요
3. 답변에 출처를 명시하세요 [Doc X]
4. 문서에 정보가 없으면 "제공된 문서에서 확인할 수 없습니다"라고 답하세요
5. 추측이나 외부 지식을 사용하지 마세요

## 출력 형식
<extracted_info>
[문서에서 추출한 관련 정보]
</extracted_info>

<answer>
[최종 답변]
</answer>

<sources>
[사용한 문서 및 섹션]
</sources>
```

### 다중 문서 요약 템플릿

```markdown
## 역할
당신은 정보 종합 전문가입니다. 여러 문서의 정보를 일관되게 통합합니다.

## 목표
{{summary_goal}}

## 문서 목록
<documents>
{{documents_with_ids}}
</documents>

## 지시
1. 각 문서의 핵심 내용을 파악하세요
2. 공통점과 차이점을 식별하세요
3. 정보를 논리적으로 구조화하세요
4. 출처를 명시하세요 [Doc X]
5. 상충되는 정보는 모두 언급하세요

## 출력 형식
<synthesis>
## 핵심 요약
[통합 요약 - 500자 이내]

## 주요 발견
1. [발견 1] [Doc X]
2. [발견 2] [Doc Y]

## 정보 충돌 (있는 경우)
- [Doc X]에서는... vs [Doc Y]에서는...

## 정보 부족
- [확인되지 않은 항목]
</synthesis>
```

---

## 성능 최적화

### 1. 토큰 효율 전략

| 전략 | 토큰 절약 | 적용 방법 |
|------|----------|----------|
| 문서 압축 | 30-50% | 불필요한 서식, 반복 제거 |
| 선택적 포함 | 50-70% | 관련 섹션만 포함 |
| 계층적 요약 | 60-80% | Map-Reduce 패턴 |
| 동적 컨텍스트 | 가변 | 질문 복잡도에 따라 조절 |

### 2. 지연 최적화

```markdown
## 병렬 처리 가능 작업
- 다중 문서 요약 (Map 단계)
- 독립적인 질문에 대한 검색
- 여러 청크 임베딩 생성

## 순차 처리 필요 작업
- 요약 통합 (Reduce 단계)
- 컨텍스트 의존적 후속 질문
- 최종 답변 생성
```

### 3. 비용 최적화

```markdown
## 전략

1. **캐싱**: 자주 사용되는 문서 요약 캐싱
2. **점진적 로딩**: 필요할 때만 추가 문서 로드
3. **모델 선택**: 간단한 작업은 Haiku, 복잡한 작업은 Sonnet
4. **청크 재사용**: 동일 세션 내 중복 검색 방지
```

---

## 에러 처리

### 컨텍스트 초과 시

```markdown
## 대응 전략

1. **문서 압축**: 요약 버전으로 교체
2. **선택적 제외**: 관련성 낮은 문서 제거
3. **청크 축소**: 더 작은 청크로 분할
4. **계층적 처리**: Map-Reduce로 전환

## 사용자 안내 메시지
"제공된 문서가 처리 한도를 초과합니다.
가장 관련성 높은 문서를 선별하여 처리했습니다.
[선별된 문서 목록]"
```

### 관련 문서 없음

```markdown
## 응답 템플릿
"제공된 문서에서 '{{query}}'에 대한 정보를 찾을 수 없습니다.

다음을 시도해 보세요:
1. 다른 키워드로 질문
2. 관련 문서 추가 제공
3. 질문 범위 조정"
```

---

## 관련 참조

- [technique-priority.md](technique-priority.md) - 기법 우선순위 (섹션 9: Long Context Tips)
- [hallucination-reduction.md](hallucination-reduction.md) - 할루시네이션 감소 기법
- [latency-optimization.md](latency-optimization.md) - 지연 최적화
- [quality-checklist.md](quality-checklist.md) - 8-Point Quality Check
