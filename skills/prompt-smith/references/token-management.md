# Token Management 가이드

프롬프트 토큰 추정, 컨텍스트 윈도우 검증, 비용 예측을 위한 가이드입니다.

---

## 개요

### 목적
- 프롬프트 토큰 수 추정
- 컨텍스트 윈도우 한계 검증
- 비용 예측 및 최적화
- LINT에서 토큰 분석 제공

### 주요 개념

```
┌─────────────────────────────────────────────────────────────┐
│              토큰 기본 개념                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  토큰 = 텍스트의 기본 단위 (단어, 부분 단어, 문자)            │
│                                                             │
│  영어: "Hello world!" → ["Hello", " world", "!"] = 3 토큰   │
│  한글: "안녕하세요" → ["안녕", "하세요"] ≈ 2-4 토큰           │
│                                                             │
│  일반 규칙:                                                  │
│  - 영어: ~4문자 = 1토큰                                      │
│  - 한글: ~2문자 = 1토큰                                      │
│  - 코드: 키워드/식별자별 1토큰                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 토큰 추정 규칙

### 언어별 추정

| 언어 | 문자당 토큰 | 예시 | 추정 토큰 |
|------|------------|------|----------|
| **영어** | ~0.25 (4자=1토큰) | "hello world" (11자) | ~3 토큰 |
| **한글** | ~0.5 (2자=1토큰) | "안녕하세요" (5자) | ~3-4 토큰 |
| **일본어** | ~0.7 (1.5자=1토큰) | "こんにちは" (5자) | ~4 토큰 |
| **중국어** | ~0.5 (2자=1토큰) | "你好世界" (4자) | ~2-3 토큰 |

### 콘텐츠 유형별 추정

| 유형 | 추정 방법 | 예시 |
|------|----------|------|
| **일반 텍스트** | 단어 수 × 1.3 | 100단어 ≈ 130 토큰 |
| **코드** | 줄 수 × 10-15 | 50줄 ≈ 500-750 토큰 |
| **JSON** | 키/값 쌍 × 5-7 | 20개 쌍 ≈ 100-140 토큰 |
| **Markdown** | 단어 수 × 1.5 | 포맷팅 오버헤드 포함 |
| **XML** | 단어 수 × 2 | 태그 오버헤드 포함 |

### 빠른 추정 공식

```markdown
## 빠른 추정 (영어/한글 혼합)

토큰 수 ≈ (영어 단어 수 × 1.3) + (한글 글자 수 × 0.5)

## 예시
"Hello, 안녕하세요. This is a test."
= (5 영어 단어 × 1.3) + (5 한글 글자 × 0.5)
= 6.5 + 2.5
≈ 9 토큰

## 보수적 추정 (안전 마진 20%)
최종 추정 = 빠른 추정 × 1.2
```

---

## 컨텍스트 윈도우

### Claude 모델별 한계

| 모델 | 입력 한계 | 출력 한계 | 총 컨텍스트 |
|------|----------|----------|------------|
| **Haiku** | 200K | 8K | 200K |
| **Sonnet** | 200K | 8K | 200K |
| **Opus** | 200K | 32K | 200K |

### 컨텍스트 구성

```
┌─────────────────────────────────────────────────────────────┐
│              컨텍스트 구성 요소                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  총 컨텍스트 = 시스템 프롬프트                                │
│              + 대화 히스토리                                  │
│              + 현재 입력                                     │
│              + 예약된 출력 공간                               │
│                                                             │
│  예시:                                                       │
│  ┌─────────────────────────────────────────┐               │
│  │ 시스템 프롬프트:     2,000 토큰          │               │
│  │ 대화 히스토리:      10,000 토큰          │               │
│  │ 현재 입력:          5,000 토큰          │               │
│  │ 출력 예약:          8,000 토큰          │               │
│  ├─────────────────────────────────────────┤               │
│  │ 총 사용:           25,000 토큰          │               │
│  │ 여유:             175,000 토큰          │               │
│  └─────────────────────────────────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 경고 임계값

| 사용률 | 상태 | 권장 조치 |
|--------|------|----------|
| < 50% | ✅ 정상 | 없음 |
| 50-80% | ⚠️ 주의 | 최적화 고려 |
| 80-90% | 🔶 경고 | 압축 또는 청킹 필요 |
| > 90% | 🔴 위험 | 즉시 최적화 필요 |

---

## LINT 토큰 분석

### 8-Point + Token Check

기존 8-Point Quality Check에 토큰 분석 단계를 추가합니다.

```markdown
## 토큰 분석 결과

| 항목 | 값 |
|------|-----|
| **추정 토큰** | ~2,500 |
| **대상 모델** | Sonnet (200K) |
| **사용률** | 1.25% |
| **예상 비용** | $0.0075/호출 |
| **상태** | ✅ 정상 |

### 세부 분석
| 구성 요소 | 토큰 | 비율 |
|----------|------|------|
| 시스템 지시 | 500 | 20% |
| 컨텍스트 | 800 | 32% |
| 예시 | 600 | 24% |
| 사용자 입력 | 600 | 24% |
```

### 경고 메시지

```markdown
## 경고 조건 및 메시지

### 50% 초과 (주의)
⚠️ 컨텍스트 사용률 55%. 긴 대화 시 최적화 권장.
- 권장: 불필요한 예시 제거, 컨텍스트 압축

### 80% 초과 (경고)
🔶 컨텍스트 사용률 85%. 출력 공간 부족 가능.
- 권장: 청킹 적용, 계층적 요약 사용

### 90% 초과 (위험)
🔴 컨텍스트 사용률 95%. 즉시 최적화 필요.
- 필수: 문서 분할, 출력 길이 제한 설정

### 출력 한계 초과 예상
⚠️ 예상 출력(~10K)이 모델 한계(8K) 초과 가능.
- 권장: max_tokens 설정 또는 출력 형식 간소화
```

---

## 비용 예측

### Claude 모델 가격표 (2026년 1월 기준)

| 모델 | 입력 (1M 토큰) | 출력 (1M 토큰) | 캐시 입력 |
|------|---------------|---------------|----------|
| **Haiku** | $0.25 | $1.25 | $0.03 |
| **Sonnet** | $3.00 | $15.00 | $0.30 |
| **Opus** | $15.00 | $75.00 | $1.50 |

### 비용 계산 공식

```markdown
## 단일 호출 비용

비용 = (입력_토큰 × 입력_가격) + (출력_토큰 × 출력_가격)

## 예시: Sonnet, 2,500 입력 + 1,000 출력

입력 비용 = 2,500 / 1,000,000 × $3.00 = $0.0075
출력 비용 = 1,000 / 1,000,000 × $15.00 = $0.0150
총 비용 = $0.0225/호출

## 월간 비용 추정 (1,000회 호출/일)

일간 = $0.0225 × 1,000 = $22.50
월간 = $22.50 × 30 = $675
```

### 비용 최적화 전략

| 전략 | 절감률 | 적용 방법 |
|------|--------|----------|
| **캐싱 활용** | 50-90% | 정적 시스템 프롬프트 캐싱 |
| **모델 선택** | 40-90% | 간단한 작업은 Haiku 사용 |
| **출력 제한** | 20-50% | max_tokens 적절히 설정 |
| **배치 처리** | 30-50% | 유사 요청 그룹화 |

---

## 토큰 효율 최적화

### 1. 프롬프트 압축

```markdown
## Before (500 토큰)
당신은 전문적인 고객 서비스 담당자입니다. 고객의 문의에 친절하고
정확하게 답변해 주세요. 항상 고객을 존중하고, 문제를 해결하기 위해
최선을 다하세요. 불확실한 경우에는 확인 후 답변드리겠다고 말씀해
주세요.

## After (200 토큰)
역할: 고객 서비스 담당자
지시:
- 친절하고 정확하게 답변
- 불확실한 경우 확인 후 답변
```

### 2. 예시 최적화

```markdown
## Before (800 토큰 - 3개 예시)
<examples>
<example>
<input>배송이 언제 도착하나요?</input>
<output>고객님, 안녕하세요. 배송 관련 문의 감사합니다.
주문하신 상품은 보통 2-3일 내 도착합니다...</output>
</example>
... (반복)
</examples>

## After (300 토큰 - 간결한 예시)
<examples>
<ex>Q: 배송 언제? A: 2-3일 내 도착</ex>
<ex>Q: 환불 요청 A: 7일 내 환불 완료</ex>
</examples>
```

### 3. 동적 컨텍스트 로딩

```markdown
## 전략

1. 기본 프롬프트: 최소 토큰으로 시작
2. 필요 시 확장: 복잡한 질문에만 추가 컨텍스트
3. 점진적 로딩: 대화가 깊어질수록 관련 정보만 유지

## 예시

기본 프롬프트: 500 토큰
+ 복잡한 질문 시: +1,000 토큰 (도메인 컨텍스트)
+ 히스토리 필요 시: +500 토큰 (요약된 대화)
```

---

## 토큰 카운팅 도구

### 추정 함수 (의사 코드)

```python
def estimate_tokens(text: str) -> int:
    """
    텍스트의 토큰 수를 추정합니다.

    추정 방법:
    - 영어: 4자 = 1토큰
    - 한글: 2자 = 1토큰
    - 특수문자: 1자 = 1토큰
    """
    english_chars = count_english(text)
    korean_chars = count_korean(text)
    special_chars = count_special(text)

    tokens = (
        english_chars / 4 +
        korean_chars / 2 +
        special_chars
    )

    # 안전 마진 20%
    return int(tokens * 1.2)
```

### Claude Code에서 사용

```bash
# 파일 토큰 추정 (간단한 방법)
wc -m your_prompt.md | awk '{print int($1 / 3)}'

# 더 정확한 추정 (tiktoken 유사)
# 영어: 단어 수 × 1.3
# 한글: 글자 수 × 0.5
```

---

## 체크리스트

### 프롬프트 작성 전

- [ ] 대상 모델의 컨텍스트 한계 확인
- [ ] 예상 출력 길이 고려
- [ ] 비용 예산 확인

### 프롬프트 작성 후

- [ ] 토큰 수 추정
- [ ] 컨텍스트 사용률 확인 (< 80% 권장)
- [ ] 비용 예측
- [ ] 최적화 여지 검토

### 프로덕션 배포 전

- [ ] 다양한 입력으로 토큰 변동 테스트
- [ ] 최악의 경우 토큰 수 계산
- [ ] 비용 상한 설정
- [ ] 모니터링 대시보드 구성

---

## 관련 참조

- [quality-checklist.md](quality-checklist.md) - 8-Point Quality Check
- [latency-optimization.md](latency-optimization.md) - 지연 최적화
- [long-context-optimization.md](long-context-optimization.md) - 긴 컨텍스트 최적화
- [../modes/lint.md](../modes/lint.md) - LINT 모드
